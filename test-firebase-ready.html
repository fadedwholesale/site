<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Firebase Readiness Test</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .error { color: #f00; font-weight: bold; }
        .success { color: #0f0; font-weight: bold; }
        .warning { color: #fa0; font-weight: bold; }
        .log { margin: 2px 0; padding: 3px; border-left: 2px solid #333; padding-left: 8px; }
        .section { margin: 20px 0; border: 1px solid #333; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Firebase Readiness Test</h1>
    <div class="section">
        <h2>🎯 Monitoring for Firebase Error:</h2>
        <p class="warning">❌ Error getting consolidated data: Error: Firebase not ready</p>
    </div>
    
    <div class="section">
        <h2>📊 System Status:</h2>
        <div id="status">Initializing...</div>
    </div>
    
    <div class="section">
        <h2>📝 Live Logs:</h2>
        <div id="logs"></div>
    </div>

    <!-- Load scripts -->
    <script src="firebase-integration-bridge.js?v=fix-getdata-20250109"></script>
    <script src="realtime-sync.js?v=fix-getdata-20250109"></script>
    <script src="data-persistence.js?v=fix-getdata-20250109"></script>
    <script src="shared-data.js?v=fix-getdata-20250109"></script>

    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        let firebaseNotReadyError = false;
        let testStartTime = Date.now();

        function addLog(type, message) {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<span style="color: #666">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // Check for the specific Firebase error
            if (message.includes('Firebase not ready')) {
                firebaseNotReadyError = true;
                addLog('error', '🚨 FIREBASE NOT READY ERROR DETECTED!');
            }
        }

        // Override console methods
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;

        console.error = (...args) => {
            originalError(...args);
            addLog('error', args.join(' '));
        };

        console.warn = (...args) => {
            originalWarn(...args);
            addLog('warning', args.join(' '));
        };

        console.log = (...args) => {
            const message = args.join(' ');
            originalLog(...args);
            // Log Firebase and initialization related messages
            if (message.includes('Firebase') || 
                message.includes('ready') || 
                message.includes('initialized') ||
                message.includes('Persistence') ||
                message.includes('SharedDataManager') ||
                message.includes('startup')) {
                addLog('success', message);
            }
        };

        // Capture uncaught errors
        window.onerror = function(message, source, lineno, colno, error) {
            addLog('error', `Uncaught: ${message} at ${source}:${lineno}:${colno}`);
        };

        // Status monitoring
        let checkCount = 0;
        const statusInterval = setInterval(() => {
            checkCount++;
            const elapsed = Math.round((Date.now() - testStartTime) / 1000);
            
            let status = `<strong>Test Time:</strong> ${elapsed}s | <strong>Checks:</strong> ${checkCount}<br><br>`;
            
            // Error status
            status += `<strong>🎯 Firebase Error Status:</strong><br>`;
            status += `Firebase Not Ready Error: ${firebaseNotReadyError ? '<span class="error">❌ DETECTED</span>' : '<span class="success">✅ None</span>'}<br><br>`;
            
            // System status
            const sdmExists = !!window.sharedDataManager;
            const fbReady = window.sharedDataManager && window.sharedDataManager.getStatus && window.sharedDataManager.getStatus().firebaseReady;
            const dpExists = !!window.dataPersistence;
            
            status += `<strong>🔧 System Components:</strong><br>`;
            status += `SharedDataManager: ${sdmExists ? '✅' : '❌'} Exists<br>`;
            status += `Firebase Ready: ${fbReady ? '✅' : '❌'} Ready<br>`;
            status += `Data Persistence: ${dpExists ? '✅' : '❌'} Exists<br>`;
            
            if (window.sharedDataManager && window.sharedDataManager.getStatus) {
                const status_obj = window.sharedDataManager.getStatus();
                status += `<br><strong>📊 Firebase Status Details:</strong><br>`;
                status += `DB Ready: ${status_obj.firebaseReady}<br>`;
                status += `Integration: ${status_obj.integration}<br>`;
                status += `Mode: ${status_obj.mode}<br>`;
            }
            
            statusDiv.innerHTML = status;
            
            if (elapsed > 60) { // Stop after 1 minute
                clearInterval(statusInterval);
                
                if (!firebaseNotReadyError) {
                    statusDiv.innerHTML += '<br><div class="success">🎉 SUCCESS: No Firebase errors in 1 minute!</div>';
                } else {
                    statusDiv.innerHTML += '<br><div class="error">❌ FAILED: Firebase readiness error detected</div>';
                }
            }
        }, 3000);

        addLog('success', '🔍 Firebase readiness monitoring started...');
        
        // Test Firebase readiness after delay
        setTimeout(async () => {
            try {
                addLog('success', '🧪 Testing SharedDataManager.getData()...');
                
                if (window.sharedDataManager && typeof window.sharedDataManager.getData === 'function') {
                    const data = await window.sharedDataManager.getData();
                    addLog('success', `✅ getData() successful: ${Object.keys(data).join(', ')}`);
                } else {
                    addLog('warning', '⚠️ SharedDataManager not available for testing');
                }
                
            } catch (error) {
                addLog('error', `❌ getData() test failed: ${error.message}`);
            }
        }, 20000);

    </script>
</body>
</html>
