<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Order Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .flow-step {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            position: relative;
        }
        .flow-step.completed { border-color: #28a745; background-color: #f8fff9; }
        .flow-step.active { border-color: #007bff; background-color: #f8f9ff; }
        .flow-step.error { border-color: #dc3545; background-color: #fff8f8; }
        .step-number {
            position: absolute;
            top: -10px;
            left: 15px;
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        #console-output {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .order-simulation {
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8fff9;
        }
    </style>
</head>
<body>
    <h1>🛒 Complete Order Flow Test</h1>
    
    <div class="test-container">
        <h3>Order Flow Simulation</h3>
        <div id="overall-status" class="status info">Ready to simulate order flow...</div>
        
        <button onclick="simulateCompleteOrderFlow()">🚀 Simulate Complete Order</button>
        <button onclick="testPartnerToAdminSync()">🔄 Test Partner → Admin Sync</button>
        <button onclick="clearOutput()">🧹 Clear Output</button>
    </div>

    <div class="order-simulation">
        <h3>📋 Order Flow Steps</h3>
        
        <div class="flow-step" id="step-1">
            <div class="step-number">1</div>
            <h4>🛒 Partner Portal: Add Products to Cart</h4>
            <div id="step-1-status" class="status info">Waiting...</div>
        </div>
        
        <div class="flow-step" id="step-2">
            <div class="step-number">2</div>
            <h4>💾 Partner Portal: Save Cart to Firebase</h4>
            <div id="step-2-status" class="status info">Waiting...</div>
        </div>
        
        <div class="flow-step" id="step-3">
            <div class="step-number">3</div>
            <h4>📋 Partner Portal: Create Order</h4>
            <div id="step-3-status" class="status info">Waiting...</div>
        </div>
        
        <div class="flow-step" id="step-4">
            <div class="step-number">4</div>
            <h4>🔄 Real-time Sync: Broadcast Order Update</h4>
            <div id="step-4-status" class="status info">Waiting...</div>
        </div>
        
        <div class="flow-step" id="step-5">
            <div class="step-number">5</div>
            <h4>🔴 Admin Portal: Receive Order Notification</h4>
            <div id="step-5-status" class="status info">Waiting...</div>
        </div>
        
        <div class="flow-step" id="step-6">
            <div class="step-number">6</div>
            <h4>📊 Admin Portal: Display in Dashboard</h4>
            <div id="step-6-status" class="status info">Waiting...</div>
        </div>
    </div>

    <div class="test-container">
        <h3>Console Output</h3>
        <div id="console-output"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Our Scripts -->
    <script src="firebase-config.js"></script>
    <script src="firebase-integration-bridge.js?v=portal-sync-ready"></script>
    <script src="shared-data.js?v=portal-sync-ready"></script>
    <script src="realtime-sync.js?v=portal-sync-ready"></script>
    <script src="cart-system.js?v=portal-sync-ready"></script>

    <script>
        // Console capture
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToOutput(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                log: '#e2e8f0',
                error: '#fc8181',
                warn: '#f6e05e',
                info: '#63b3ed'
            }[type];
            
            consoleOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToOutput(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToOutput('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToOutput('WARN: ' + args.join(' '), 'warn');
        };

        function updateStepStatus(stepId, message, type, state = null) {
            const stepDiv = document.getElementById(stepId);
            const statusDiv = document.getElementById(`${stepId}-status`);
            
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            if (state) {
                stepDiv.className = `flow-step ${state}`;
            }
        }

        function updateOverallStatus(message, type) {
            const statusDiv = document.getElementById('overall-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Simulate test user
        const testUser = {
            email: 'test-partner@fadedskies.com',
            name: 'Test Partner',
            role: 'partner'
        };

        // Set test user
        window.currentUser = testUser;

        // Simulate complete order flow
        async function simulateCompleteOrderFlow() {
            console.log('🚀 Starting Complete Order Flow Simulation...');
            updateOverallStatus('Running order flow simulation...', 'info');

            try {
                // Step 1: Add products to cart
                updateStepStatus('step-1', 'Adding test products to cart...', 'info', 'active');
                await simulateAddToCart();
                updateStepStatus('step-1', '✅ Products added to cart successfully', 'success', 'completed');

                // Step 2: Save cart to Firebase
                updateStepStatus('step-2', 'Saving cart to Firebase...', 'info', 'active');
                await simulateSaveCart();
                updateStepStatus('step-2', '✅ Cart saved to Firebase successfully', 'success', 'completed');

                // Step 3: Create order
                updateStepStatus('step-3', 'Creating order from cart...', 'info', 'active');
                const order = await simulateCreateOrder();
                updateStepStatus('step-3', `✅ Order created successfully: ${order.id}`, 'success', 'completed');

                // Step 4: Real-time sync
                updateStepStatus('step-4', 'Broadcasting order update...', 'info', 'active');
                await simulateRealTimeSync(order);
                updateStepStatus('step-4', '✅ Order broadcasted via real-time sync', 'success', 'completed');

                // Step 5: Admin notification (simulated)
                updateStepStatus('step-5', 'Simulating admin notification...', 'info', 'active');
                await simulateAdminNotification(order);
                updateStepStatus('step-5', '✅ Admin would receive notification', 'success', 'completed');

                // Step 6: Dashboard display
                updateStepStatus('step-6', 'Verifying order in system...', 'info', 'active');
                await simulateDashboardUpdate(order);
                updateStepStatus('step-6', '✅ Order visible in admin dashboard', 'success', 'completed');

                updateOverallStatus('🎉 Complete Order Flow SUCCESSFUL! 🎉', 'success');
                console.log('🎉 =================================');
                console.log('🎉 COMPLETE ORDER FLOW SUCCESSFUL!');
                console.log('🎉 ✅ Cart Management: Working');
                console.log('🎉 ✅ Order Creation: Working');
                console.log('🎉 ✅ Real-time Sync: Working');
                console.log('🎉 ✅ Firebase Integration: Working');
                console.log('🎉 =================================');

            } catch (error) {
                console.error('❌ Order Flow Failed:', error.message);
                updateOverallStatus(`❌ Order flow failed: ${error.message}`, 'error');
                
                // Mark current step as error
                const activeStep = document.querySelector('.flow-step.active');
                if (activeStep) {
                    const stepId = activeStep.id;
                    updateStepStatus(stepId, `❌ Error: ${error.message}`, 'error', 'error');
                }
            }
        }

        // Simulate adding products to cart
        async function simulateAddToCart() {
            console.log('🛒 Step 1: Simulating add to cart...');
            
            if (!window.cartManager) {
                throw new Error('CartManager not available');
            }

            // Create test products
            const testProducts = [
                {
                    id: 'test-product-1',
                    strain: 'Test THCA Flower',
                    price: 100,
                    image: 'https://via.placeholder.com/300x200'
                },
                {
                    id: 'test-product-2',
                    strain: 'Test THCA Concentrate',
                    price: 150,
                    image: 'https://via.placeholder.com/300x200'
                }
            ];

            // Add products to cart
            for (const product of testProducts) {
                window.cartManager.cart.push({
                    ...product,
                    quantity: 2
                });
            }

            console.log(`✅ Added ${testProducts.length} test products to cart`);
            return true;
        }

        // Simulate saving cart to Firebase
        async function simulateSaveCart() {
            console.log('💾 Step 2: Simulating save cart to Firebase...');
            
            if (!window.sharedDataManager) {
                throw new Error('SharedDataManager not available');
            }

            if (!window.currentUser) {
                throw new Error('No user authenticated');
            }

            // Save cart to Firebase
            await window.sharedDataManager.updateCart(window.currentUser.email, window.cartManager.cart);
            console.log('✅ Cart saved to Firebase successfully');
            return true;
        }

        // Simulate creating order
        async function simulateCreateOrder() {
            console.log('📋 Step 3: Simulating order creation...');
            
            if (!window.sharedDataManager) {
                throw new Error('SharedDataManager not available');
            }

            const orderData = {
                partner: window.currentUser.email,
                items: window.cartManager.cart,
                total: window.cartManager.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                status: 'PENDING',
                date: new Date().toISOString(),
                customerInfo: {
                    name: window.currentUser.name,
                    email: window.currentUser.email,
                    business: 'Test Business'
                }
            };

            const order = await window.sharedDataManager.addOrder(orderData);
            console.log(`✅ Order created successfully: ${order.id}`);
            return order;
        }

        // Simulate real-time sync
        async function simulateRealTimeSync(order) {
            console.log('��� Step 4: Simulating real-time sync broadcast...');
            
            if (!window.realTimeSync) {
                throw new Error('RealTimeSync not available');
            }

            // Broadcast order update
            window.realTimeSync.broadcast('order_added', order);
            console.log('✅ Order broadcasted via real-time sync');
            return true;
        }

        // Simulate admin notification
        async function simulateAdminNotification(order) {
            console.log('🔴 Step 5: Simulating admin notification...');
            
            // In a real scenario, this would trigger notifications in admin portal
            console.log(`📧 Admin would receive notification: New order ${order.id} from ${order.partner}`);
            console.log('✅ Admin notification simulation complete');
            return true;
        }

        // Simulate dashboard update
        async function simulateDashboardUpdate(order) {
            console.log('📊 Step 6: Simulating dashboard update...');
            
            // Verify order can be retrieved
            const orders = await window.sharedDataManager.getOrders();
            const foundOrder = orders.find(o => o.id === order.id);
            
            if (!foundOrder) {
                throw new Error('Order not found in database');
            }

            console.log('✅ Order found in database, would appear in admin dashboard');
            return true;
        }

        // Test partner to admin sync specifically
        async function testPartnerToAdminSync() {
            console.log('🔄 Testing Partner → Admin Sync...');
            updateOverallStatus('Testing sync between portals...', 'info');

            try {
                // Test sync functionality
                if (!window.realTimeSync) {
                    throw new Error('RealTimeSync not available');
                }

                const syncStatus = window.realTimeSync.getSyncStatus();
                console.log('📊 Sync Status:', syncStatus);

                if (!syncStatus.isOnline) {
                    throw new Error('Sync reports offline');
                }

                // Test data retrieval
                const data = await window.sharedDataManager.getData();
                console.log('📊 Data retrieved:', Object.keys(data));

                updateOverallStatus('✅ Partner → Admin sync is working correctly', 'success');
                console.log('✅ Partner → Admin sync test PASSED');

            } catch (error) {
                console.error('❌ Sync test failed:', error.message);
                updateOverallStatus(`❌ Sync test failed: ${error.message}`, 'error');
            }
        }

        function clearOutput() {
            consoleOutput.innerHTML = '';
            updateOverallStatus('Ready to simulate order flow...', 'info');
            
            // Reset all step statuses
            for (let i = 1; i <= 6; i++) {
                updateStepStatus(`step-${i}`, 'Waiting...', 'info');
                document.getElementById(`step-${i}`).className = 'flow-step';
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Order Flow Test page loaded');
            console.log('⏳ Waiting for systems to initialize...');
            
            // Auto-run test after systems have time to initialize
            setTimeout(() => {
                console.log('🎯 Auto-starting order flow test...');
                simulateCompleteOrderFlow();
            }, 5000);
        });

        // Monitor for errors
        window.addEventListener('error', (event) => {
            console.error('💥 Page error:', event.error?.message || event.message);
        });
    </script>
</body>
</html>
