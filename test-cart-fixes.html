<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Cart System Fix Test</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .error { color: #f00; font-weight: bold; }
        .success { color: #0f0; font-weight: bold; }
        .warning { color: #fa0; font-weight: bold; }
        .log { margin: 2px 0; padding: 3px; border-left: 2px solid #333; padding-left: 8px; }
        .section { margin: 20px 0; border: 1px solid #333; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Cart System Fix Test</h1>
    <div class="section">
        <h2>üéØ Target Cart Errors Being Monitored:</h2>
        <ul>
            <li class="warning">TypeError: this.cart.map is not a function</li>
            <li class="warning">TypeError: this.cart.forEach is not a function</li>
            <li class="warning">TypeError: window.cartManager.cart.forEach is not a function</li>
        </ul>
    </div>
    
    <div class="section">
        <h2>üìä Cart System Status:</h2>
        <div id="status">Initializing...</div>
    </div>
    
    <div class="section">
        <h2>üìù Live Logs:</h2>
        <div id="logs"></div>
    </div>

    <!-- Load scripts with new cache busting -->
    <script src="firebase-integration-bridge.js?v=fix-cart-arrays-20250109"></script>
    <script src="realtime-sync.js?v=fix-cart-arrays-20250109"></script>
    <script src="shared-data.js?v=fix-cart-arrays-20250109"></script>
    <script src="cart-system.js?v=fix-cart-arrays-20250109"></script>
    <script src="main-app.js?v=fix-cart-arrays-20250109"></script>

    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        let errors = {
            cartMapError: false,
            cartForEachError: false,
            cartManagerForEachError: false
        };
        let testStartTime = Date.now();

        function addLog(type, message) {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<span style="color: #666">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // Check for target errors
            if (message.includes('this.cart.map is not a function')) {
                errors.cartMapError = true;
                addLog('error', 'üö® CART.MAP ERROR DETECTED!');
            }
            if (message.includes('this.cart.forEach is not a function')) {
                errors.cartForEachError = true;
                addLog('error', 'üö® CART.FOREACH ERROR DETECTED!');
            }
            if (message.includes('window.cartManager.cart.forEach is not a function')) {
                errors.cartManagerForEachError = true;
                addLog('error', 'üö® CARTMANAGER.CART.FOREACH ERROR DETECTED!');
            }
        }

        // Override console methods
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;

        console.error = (...args) => {
            originalError(...args);
            addLog('error', args.join(' '));
        };

        console.warn = (...args) => {
            originalWarn(...args);
            addLog('warning', args.join(' '));
        };

        console.log = (...args) => {
            const message = args.join(' ');
            originalLog(...args);
            // Log cart-related messages
            if (message.includes('cart') || 
                message.includes('Cart') || 
                message.includes('loading') ||
                message.includes('array') ||
                message.includes('initialized')) {
                addLog('success', message);
            }
        };

        // Capture uncaught errors
        window.onerror = function(message, source, lineno, colno, error) {
            addLog('error', `Uncaught: ${message} at ${source}:${lineno}:${colno}`);
        };

        // Status monitoring
        let checkCount = 0;
        const statusInterval = setInterval(() => {
            checkCount++;
            const elapsed = Math.round((Date.now() - testStartTime) / 1000);
            
            let status = `<strong>Test Time:</strong> ${elapsed}s | <strong>Checks:</strong> ${checkCount}<br><br>`;
            
            // Error status
            status += `<strong>üéØ Cart Error Status:</strong><br>`;
            status += `Cart Map Error: ${errors.cartMapError ? '<span class="error">‚ùå DETECTED</span>' : '<span class="success">‚úÖ None</span>'}<br>`;
            status += `Cart ForEach Error: ${errors.cartForEachError ? '<span class="error">‚ùå DETECTED</span>' : '<span class="success">‚úÖ None</span>'}<br>`;
            status += `CartManager ForEach Error: ${errors.cartManagerForEachError ? '<span class="error">‚ùå DETECTED</span>' : '<span class="success">‚úÖ None</span>'}<br><br>`;
            
            // Cart system status
            const cartManagerExists = !!window.cartManager;
            const cartIsArray = window.cartManager && Array.isArray(window.cartManager.cart);
            const cartLength = cartIsArray ? window.cartManager.cart.length : 'N/A';
            
            status += `<strong>üõí Cart System:</strong><br>`;
            status += `CartManager: ${cartManagerExists ? '‚úÖ' : '‚ùå'} Exists<br>`;
            status += `Cart Array: ${cartIsArray ? '‚úÖ' : '‚ùå'} Valid (${cartLength} items)<br>`;
            
            if (window.cartManager && window.cartManager.cart) {
                const cartType = typeof window.cartManager.cart;
                status += `Cart Type: ${cartType}<br>`;
            }
            
            statusDiv.innerHTML = status;
            
            if (elapsed > 60) { // Stop after 1 minute
                clearInterval(statusInterval);
                const totalErrors = Object.values(errors).filter(x => x).length;
                
                if (totalErrors === 0) {
                    statusDiv.innerHTML += '<br><div class="success">üéâ SUCCESS: No cart errors in 1 minute!</div>';
                } else {
                    statusDiv.innerHTML += `<br><div class="error">‚ùå FAILED: ${totalErrors} cart error(s) detected</div>`;
                }
            }
        }, 3000);

        addLog('success', 'üîç Cart error monitoring started...');
        
        // Test cart operations after delay
        setTimeout(() => {
            try {
                addLog('success', 'üß™ Testing cart operations...');
                
                if (window.cartManager) {
                    // Test getTotals
                    const totals = window.cartManager.getTotals();
                    addLog('success', `‚úÖ getTotals() test passed: ${JSON.stringify(totals)}`);
                    
                    // Test updateDisplay
                    window.cartManager.updateDisplay();
                    addLog('success', '‚úÖ updateDisplay() test passed');
                    
                    // Test cart array
                    addLog('success', `Cart is array: ${Array.isArray(window.cartManager.cart)}`);
                    addLog('success', `Cart length: ${window.cartManager.cart.length}`);
                    
                } else {
                    addLog('warning', '‚ö†Ô∏è CartManager not available for testing');
                }
                
                // Test checkInventoryLive function
                if (window.checkInventoryLive && typeof window.checkInventoryLive === 'function') {
                    window.checkInventoryLive();
                    addLog('success', '‚úÖ checkInventoryLive() test called');
                } else {
                    addLog('warning', '‚ö†Ô∏è checkInventoryLive not available');
                }
                
            } catch (error) {
                addLog('error', `‚ùå Cart operations test failed: ${error.message}`);
            }
        }, 15000);

    </script>
</body>
</html>
