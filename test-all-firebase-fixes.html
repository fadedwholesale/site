<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>All Firebase Fixes - Comprehensive Test</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .error { color: #f00; font-weight: bold; }
        .success { color: #0f0; font-weight: bold; }
        .warning { color: #fa0; font-weight: bold; }
        .log { margin: 2px 0; padding: 3px; border-left: 2px solid #333; padding-left: 8px; }
        .section { margin: 20px 0; border: 1px solid #333; padding: 15px; border-radius: 5px; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .status-item { background: #111; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>🔥 Complete Firebase Readiness Fix Test</h1>
    
    <div class="section">
        <h2>🎯 Target Firebase Errors Monitored:</h2>
        <ul>
            <li class="warning">❌ Error getting consolidated data: Error: Firebase not ready</li>
            <li class="warning">❌ Error loading cart: Error: Firebase not ready</li>
            <li class="warning">❌ [Any method]: Error: Firebase not ready</li>
        </ul>
    </div>
    
    <div class="section">
        <h2>📊 Real-time Test Status:</h2>
        <div id="status">Initializing comprehensive Firebase test...</div>
    </div>
    
    <div class="section">
        <h2>🧪 Method Tests:</h2>
        <div id="methodTests" class="status-grid">
            <div class="status-item">getData(): <span id="getDataStatus">⏳ Pending</span></div>
            <div class="status-item">getProducts(): <span id="getProductsStatus">⏳ Pending</span></div>
            <div class="status-item">getOrders(): <span id="getOrdersStatus">⏳ Pending</span></div>
            <div class="status-item">getCart(): <span id="getCartStatus">⏳ Pending</span></div>
            <div class="status-item">getSystemConfig(): <span id="getSystemConfigStatus">⏳ Pending</span></div>
        </div>
    </div>
    
    <div class="section">
        <h2>📝 Live Event Stream:</h2>
        <div id="logs" style="max-height: 400px; overflow-y: auto; background: #111; padding: 10px; border-radius: 5px;"></div>
    </div>

    <!-- Load all scripts with latest cache busting -->
    <script src="firebase-integration-bridge.js?v=fix-cart-firebase-v3"></script>
    <script src="shared-data.js?v=fix-cart-firebase-v3"></script>
    <script src="cart-system.js?v=fix-cart-firebase-v3"></script>
    <script src="main-app.js?v=fix-cart-firebase-v3"></script>

    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        let firebaseErrors = {
            getData: false,
            getProducts: false,
            getOrders: false,
            getCart: false,
            getSystemConfig: false,
            any: false
        };
        let testStartTime = Date.now();
        let logCount = 0;

        function addLog(type, message) {
            logCount++;
            const div = document.createElement('div');
            div.className = `log ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `<span style="color: #666">[${timestamp}]</span> ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // Check for Firebase errors
            if (message.includes('Firebase not ready')) {
                firebaseErrors.any = true;
                
                if (message.includes('getData')) firebaseErrors.getData = true;
                if (message.includes('getProducts')) firebaseErrors.getProducts = true;
                if (message.includes('getOrders')) firebaseErrors.getOrders = true;
                if (message.includes('getCart')) firebaseErrors.getCart = true;
                if (message.includes('getSystemConfig')) firebaseErrors.getSystemConfig = true;
                
                addLog('error', `🚨 FIREBASE ERROR DETECTED: ${message}`);
            }
        }

        // Comprehensive console monitoring
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;

        console.error = (...args) => {
            originalError(...args);
            addLog('error', args.join(' '));
        };

        console.warn = (...args) => {
            originalWarn(...args);
            addLog('warning', args.join(' '));
        };

        console.log = (...args) => {
            const message = args.join(' ');
            originalLog(...args);
            
            if (message.includes('Firebase') || 
                message.includes('ready') || 
                message.includes('Cart') ||
                message.includes('SharedDataManager') ||
                message.includes('initialized')) {
                addLog('success', message);
            }
        };

        window.onerror = function(message, source, lineno, colno, error) {
            addLog('error', `Global Error: ${message} at ${source}:${lineno}:${colno}`);
            return false;
        };

        // Test individual methods
        async function testMethods() {
            const methods = [
                { name: 'getData', statusId: 'getDataStatus' },
                { name: 'getProducts', statusId: 'getProductsStatus' },
                { name: 'getOrders', statusId: 'getOrdersStatus' },
                { name: 'getCart', statusId: 'getCartStatus', args: ['test@example.com'] },
                { name: 'getSystemConfig', statusId: 'getSystemConfigStatus' }
            ];

            for (const method of methods) {
                const statusEl = document.getElementById(method.statusId);
                
                try {
                    if (!window.sharedDataManager || typeof window.sharedDataManager[method.name] !== 'function') {
                        statusEl.innerHTML = '<span class="warning">❌ Not Available</span>';
                        continue;
                    }

                    statusEl.innerHTML = '<span class="warning">🧪 Testing...</span>';
                    
                    const args = method.args || [];
                    const result = await window.sharedDataManager[method.name](...args);
                    
                    statusEl.innerHTML = '<span class="success">✅ Success</span>';
                    addLog('success', `✅ ${method.name}() test passed`);
                    
                } catch (error) {
                    statusEl.innerHTML = '<span class="error">❌ Failed</span>';
                    addLog('error', `❌ ${method.name}() test failed: ${error.message}`);
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // Status monitoring every 3 seconds
        let checkCount = 0;
        const statusInterval = setInterval(() => {
            checkCount++;
            const elapsed = Math.round((Date.now() - testStartTime) / 1000);
            
            let status = `<strong>⏱️ Test Duration:</strong> ${elapsed}s | <strong>Checks:</strong> ${checkCount} | <strong>Logs:</strong> ${logCount}<br><br>`;
            
            // Overall status
            const totalErrors = Object.values(firebaseErrors).filter(x => x).length;
            if (totalErrors === 0) {
                status += `<span class="success">✅ ALL TESTS PASSING - No Firebase errors (${elapsed}s clean)</span><br><br>`;
            } else {
                status += `<span class="error">❌ ${totalErrors} Firebase error type(s) detected</span><br><br>`;
            }
            
            // Error breakdown
            status += `<strong>🎯 Error Status by Method:</strong><br>`;
            status += `getData: ${firebaseErrors.getData ? '❌' : '✅'} | `;
            status += `getProducts: ${firebaseErrors.getProducts ? '❌' : '✅'} | `;
            status += `getOrders: ${firebaseErrors.getOrders ? '❌' : '✅'}<br>`;
            status += `getCart: ${firebaseErrors.getCart ? '❌' : '✅'} | `;
            status += `getSystemConfig: ${firebaseErrors.getSystemConfig ? '❌' : '✅'}<br><br>`;
            
            // System status
            const sdmExists = !!window.sharedDataManager;
            const cartExists = !!window.cartManager;
            
            status += `<strong>🔧 System Components:</strong><br>`;
            status += `SharedDataManager: ${sdmExists ? '✅' : '❌'} | `;
            status += `CartManager: ${cartExists ? '✅' : '❌'}<br>`;
            
            if (window.sharedDataManager && window.sharedDataManager.getStatus) {
                try {
                    const sysStatus = window.sharedDataManager.getStatus();
                    status += `Firebase Ready: ${sysStatus.firebaseReady ? '✅' : '❌'} | `;
                    status += `Integration: ${sysStatus.integration ? '✅' : '❌'}<br>`;
                } catch (e) {
                    status += `Status Check: ❌ Error<br>`;
                }
            }
            
            statusDiv.innerHTML = status;
            
            // Stop test after 3 minutes
            if (elapsed > 180) {
                clearInterval(statusInterval);
                
                if (totalErrors === 0) {
                    statusDiv.innerHTML += '<br><div class="success" style="font-size: 20px; padding: 15px; border: 3px solid #0f0; margin: 15px 0; text-align: center;">🎉 COMPLETE SUCCESS: All Firebase fixes working perfectly!</div>';
                } else {
                    statusDiv.innerHTML += '<br><div class="error" style="font-size: 20px; padding: 15px; border: 3px solid #f00; margin: 15px 0; text-align: center;">❌ SOME ISSUES REMAIN: Firebase errors still occurring</div>';
                }
            }
        }, 3000);

        // Run method tests after delay
        setTimeout(testMethods, 15000);

        addLog('success', '🔍 Comprehensive Firebase monitoring started...');
        addLog('success', '📋 Testing all Firebase methods for readiness errors...');
    </script>
</body>
</html>
