<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Complete Fix Test</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .error { color: #f00; font-weight: bold; }
        .success { color: #0f0; font-weight: bold; }
        .warning { color: #fa0; font-weight: bold; }
        .log { margin: 2px 0; padding: 3px; border-left: 2px solid #333; padding-left: 8px; }
        .section { margin: 20px 0; border: 1px solid #333; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Complete Fix Verification Test</h1>
    <div class="section">
        <h2>ğŸ¯ Target Errors Being Monitored:</h2>
        <ul>
            <li class="warning">TypeError: products.filter is not a function</li>
            <li class="warning">Error: Firebase not ready</li>
        </ul>
    </div>
    
    <div class="section">
        <h2>ğŸ“Š Test Status:</h2>
        <div id="status">Initializing...</div>
    </div>
    
    <div class="section">
        <h2>ğŸ“ Live Logs:</h2>
        <div id="logs"></div>
    </div>

    <!-- Load scripts with cache busting -->
    <script src="firebase-integration-bridge.js?v=fix-getdata-20250109"></script>
    <script src="realtime-sync.js?v=fix-getdata-20250109"></script>
    <script src="data-persistence.js?v=fix-getdata-20250109"></script>
    <script src="shared-data.js?v=fix-getdata-20250109"></script>
    <script src="main-app.js?v=fix-getdata-20250109"></script>

    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        let errors = {
            filterError: false,
            firebaseError: false
        };
        let testStartTime = Date.now();

        function addLog(type, message) {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<span style="color: #666">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // Check for target errors
            if (message.includes('products.filter is not a function')) {
                errors.filterError = true;
                addLog('error', 'ğŸš¨ FILTER ERROR DETECTED!');
            }
            if (message.includes('Firebase not ready')) {
                errors.firebaseError = true;
                addLog('error', 'ğŸš¨ FIREBASE ERROR DETECTED!');
            }
        }

        // Override console methods
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;

        console.error = (...args) => {
            originalError(...args);
            addLog('error', args.join(' '));
        };

        console.warn = (...args) => {
            originalWarn(...args);
            addLog('warning', args.join(' '));
        };

        console.log = (...args) => {
            const message = args.join(' ');
            originalLog(...args);
            // Log relevant messages
            if (message.includes('Loading') || 
                message.includes('Loaded') || 
                message.includes('ready') ||
                message.includes('initialized') ||
                message.includes('Firebase') ||
                message.includes('products') ||
                message.includes('array')) {
                addLog('success', message);
            }
        };

        // Capture uncaught errors
        window.onerror = function(message, source, lineno, colno, error) {
            addLog('error', `Uncaught: ${message} at ${source}:${lineno}:${colno}`);
        };

        // Status monitoring
        let checkCount = 0;
        const statusInterval = setInterval(() => {
            checkCount++;
            const elapsed = Math.round((Date.now() - testStartTime) / 1000);
            
            let status = `<strong>Test Time:</strong> ${elapsed}s | <strong>Checks:</strong> ${checkCount}<br><br>`;
            
            // Error status
            status += `<strong>ğŸ¯ Error Status:</strong><br>`;
            status += `Filter Error: ${errors.filterError ? '<span class="error">âŒ DETECTED</span>' : '<span class="success">âœ… None</span>'}<br>`;
            status += `Firebase Error: ${errors.firebaseError ? '<span class="error">âŒ DETECTED</span>' : '<span class="success">âœ… None</span>'}<br><br>`;
            
            // System status
            const productsType = typeof window.products;
            const productsIsArray = Array.isArray(window.products);
            const productsLength = Array.isArray(window.products) ? window.products.length : 'N/A';
            const ordersType = typeof window.orders;
            const ordersIsArray = Array.isArray(window.orders);
            const ordersLength = Array.isArray(window.orders) ? window.orders.length : 'N/A';
            
            status += `<strong>ğŸ“Š Global Variables:</strong><br>`;
            status += `Products: ${productsIsArray ? 'âœ…' : 'âŒ'} Array (${productsLength} items)<br>`;
            status += `Orders: ${ordersIsArray ? 'âœ…' : 'âŒ'} Array (${ordersLength} items)<br><br>`;
            
            // System components
            const sdmExists = !!window.sharedDataManager;
            const sdmReady = sdmExists && window.sharedDataManager.getStatus && window.sharedDataManager.getStatus().firebaseReady;
            const mainAppReady = !!window.updateAllViews;
            
            status += `<strong>ğŸ”§ System Components:</strong><br>`;
            status += `SharedDataManager: ${sdmExists ? 'âœ…' : 'âŒ'} Exists<br>`;
            status += `Firebase Ready: ${sdmReady ? 'âœ…' : 'ï¿½ï¿½'} Ready<br>`;
            status += `Main App: ${mainAppReady ? 'âœ…' : 'âŒ'} Loaded<br>`;
            
            statusDiv.innerHTML = status;
            
            if (elapsed > 90) { // Stop after 90 seconds
                clearInterval(statusInterval);
                const successCount = Object.values(errors).filter(x => !x).length;
                const totalErrors = Object.values(errors).filter(x => x).length;
                
                if (totalErrors === 0) {
                    statusDiv.innerHTML += '<br><div class="success">ğŸ‰ SUCCESS: No target errors detected in 90 seconds!</div>';
                } else {
                    statusDiv.innerHTML += `<br><div class="error">âŒ FAILED: ${totalErrors} error type(s) detected</div>`;
                }
            }
        }, 3000);

        addLog('success', 'ğŸ” Comprehensive error monitoring started...');
        
        // Test specific functions after delay
        setTimeout(() => {
            try {
                addLog('success', 'ğŸ§ª Testing updateAllViews...');
                if (window.updateAllViews && typeof window.updateAllViews === 'function') {
                    window.updateAllViews();
                    addLog('success', 'âœ… updateAllViews test passed');
                } else {
                    addLog('warning', 'âš ï¸ updateAllViews not available');
                }
            } catch (error) {
                addLog('error', `âŒ updateAllViews test failed: ${error.message}`);
            }
        }, 15000);

        // Test data loading functions
        setTimeout(() => {
            try {
                addLog('success', 'ğŸ§ª Testing data state...');
                addLog('success', `Products array check: ${Array.isArray(window.products) ? 'PASS' : 'FAIL'}`);
                addLog('success', `Orders array check: ${Array.isArray(window.orders) ? 'PASS' : 'FAIL'}`);
                
                if (window.sharedDataManager && window.sharedDataManager.getStatus) {
                    const status = window.sharedDataManager.getStatus();
                    addLog('success', `Firebase ready: ${status.firebaseReady ? 'PASS' : 'FAIL'}`);
                }
            } catch (error) {
                addLog('error', `âŒ Data state test failed: ${error.message}`);
            }
        }, 30000);

    </script>
</body>
</html>
